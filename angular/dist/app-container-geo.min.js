/*
 * app-container-geo
 * Version: 1.0.0 - 2017-09-14
 */
!function(a){function b(){var a=arguments[0],c=b.cache;return c[a]&&c.hasOwnProperty(a)||(c[a]=b.parse(a)),b.format.call(null,c[a],arguments)}function c(a){return Object.prototype.toString.call(a).slice(8,-1).toLowerCase()}function d(a,b){return Array(b+1).join(a)}var e={not_string:/[^s]/,number:/[diefg]/,json:/[j]/,not_json:/[^j]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-gijosuxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/};b.format=function(a,f){var g,h,i,j,k,l,m,n=1,o=a.length,p="",q=[],r=!0,s="";for(h=0;o>h;h++)if(p=c(a[h]),"string"===p)q[q.length]=a[h];else if("array"===p){if(j=a[h],j[2])for(g=f[n],i=0;i<j[2].length;i++){if(!g.hasOwnProperty(j[2][i]))throw new Error(b("[sprintf] property '%s' does not exist",j[2][i]));g=g[j[2][i]]}else g=j[1]?f[j[1]]:f[n++];if("function"==c(g)&&(g=g()),e.not_string.test(j[8])&&e.not_json.test(j[8])&&"number"!=c(g)&&isNaN(g))throw new TypeError(b("[sprintf] expecting number but found %s",c(g)));switch(e.number.test(j[8])&&(r=g>=0),j[8]){case"b":g=g.toString(2);break;case"c":g=String.fromCharCode(g);break;case"d":case"i":g=parseInt(g,10);break;case"j":g=JSON.stringify(g,null,j[6]?parseInt(j[6]):0);break;case"e":g=j[7]?g.toExponential(j[7]):g.toExponential();break;case"f":g=j[7]?parseFloat(g).toFixed(j[7]):parseFloat(g);break;case"g":g=j[7]?parseFloat(g).toPrecision(j[7]):parseFloat(g);break;case"o":g=g.toString(8);break;case"s":g=(g=String(g))&&j[7]?g.substring(0,j[7]):g;break;case"u":g>>>=0;break;case"x":g=g.toString(16);break;case"X":g=g.toString(16).toUpperCase()}e.json.test(j[8])?q[q.length]=g:(!e.number.test(j[8])||r&&!j[3]?s="":(s=r?"+":"-",g=g.toString().replace(e.sign,"")),l=j[4]?"0"===j[4]?"0":j[4].charAt(1):" ",m=j[6]-(s+g).length,k=j[6]&&m>0?d(l,m):"",q[q.length]=j[5]?s+g+k:"0"===l?s+k+g:k+s+g)}return q.join("")},b.cache={},b.parse=function(a){for(var b=a,c=[],d=[],f=0;b;){if(null!==(c=e.text.exec(b)))d[d.length]=c[0];else if(null!==(c=e.modulo.exec(b)))d[d.length]="%";else{if(null===(c=e.placeholder.exec(b)))throw new SyntaxError("[sprintf] unexpected placeholder");if(c[2]){f|=1;var g=[],h=c[2],i=[];if(null===(i=e.key.exec(h)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(g[g.length]=i[1];""!==(h=h.substring(i[0].length));)if(null!==(i=e.key_access.exec(h)))g[g.length]=i[1];else{if(null===(i=e.index_access.exec(h)))throw new SyntaxError("[sprintf] failed to parse named argument key");g[g.length]=i[1]}c[2]=g}else f|=2;if(3===f)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");d[d.length]=c}b=b.substring(c[0].length)}return d};var f=function(a,c,d){return d=(c||[]).slice(0),d.splice(0,0,a),b.apply(null,d)};"undefined"!=typeof exports?(exports.sprintf=b,exports.vsprintf=f):(a.sprintf=b,a.vsprintf=f,"function"==typeof define&&define.amd&&define(function(){return{sprintf:b,vsprintf:f}}))}("undefined"==typeof window?this:window),function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):b(a.topojson=a.topojson||{})}(this,function(a){"use strict";function b(a,b,d,e){c(a,b,d),c(a,b,b+e),c(a,b+e,d)}function c(a,b,c){for(var d,e=b+(c-- -b>>1);b<e;++b,--c)d=a[b],a[b]=a[c],a[c]=d}function d(a){return(a&&N.hasOwnProperty(a.type)?N[a.type]:f)(a)}function e(a){var b=a.geometry;return null==b?a.type=null:(f(b),a.type=b.type,b.geometries?a.geometries=b.geometries:b.coordinates&&(a.coordinates=b.coordinates),b.bbox&&(a.bbox=b.bbox)),delete a.geometry,a}function f(a){return a?(O.hasOwnProperty(a.type)&&O[a.type](a),a):{type:null}}function g(a){var b,c=a[0],d=a[1];return d<c&&(b=c,c=d,d=b),c+31*d}function h(a,b){var c,d=a[0],e=a[1],f=b[0],g=b[1];return e<d&&(c=d,d=e,e=c),g<f&&(c=f,f=g,g=c),d===f&&e===g}function i(){return!0}function j(a){return a}function k(a){return null!=a.type}function l(a,b){var c=b.id,d=b.bbox,e=null==b.properties?{}:b.properties,f=m(a,b);return null==c&&null==d?{type:"Feature",properties:e,geometry:f}:null==d?{type:"Feature",id:c,properties:e,geometry:f}:{type:"Feature",id:c,bbox:d,properties:e,geometry:f}}function m(a,b){function c(a,b){b.length&&b.pop();for(var c=j[a<0?~a:a],d=0,e=c.length;d<e;++d)b.push(i(c[d].slice(),d));a<0&&X(b,e)}function d(a){return i(a.slice())}function e(a){for(var b=[],d=0,e=a.length;d<e;++d)c(a[d],b);return b.length<2&&b.push(b[0].slice()),b}function f(a){for(var b=e(a);b.length<4;)b.push(b[0].slice());return b}function g(a){return a.map(f)}function h(a){var b,c=a.type;switch(c){case"GeometryCollection":return{type:c,geometries:a.geometries.map(h)};case"Point":b=d(a.coordinates);break;case"MultiPoint":b=a.coordinates.map(d);break;case"LineString":b=e(a.arcs);break;case"MultiLineString":b=a.arcs.map(e);break;case"Polygon":b=g(a.arcs);break;case"MultiPolygon":b=a.arcs.map(g);break;default:return null}return{type:c,coordinates:b}}var i=V(a),j=a.arcs;return h(b)}function n(a,b,c){var d,e,f;if(arguments.length>1)d=o(a,b,c);else for(e=0,d=new Array(f=a.arcs.length);e<f;++e)d[e]=e;return{type:"MultiLineString",arcs:Z(a,d)}}function o(a,b,c){function d(a){var b=a<0?~a:a;(k[b]||(k[b]=[])).push({i:a,g:i})}function e(a){a.forEach(d)}function f(a){a.forEach(e)}function g(a){a.forEach(f)}function h(a){switch(i=a,a.type){case"GeometryCollection":a.geometries.forEach(h);break;case"LineString":e(a.arcs);break;case"MultiLineString":case"Polygon":f(a.arcs);break;case"MultiPolygon":g(a.arcs)}}var i,j=[],k=[];return h(b),k.forEach(null==c?function(a){j.push(a[0].i)}:function(a){c(a[0].g,a[a.length-1].g)&&j.push(a[0].i)}),j}function p(a){for(var b,c=-1,d=a.length,e=a[d-1],f=0;++c<d;)b=e,e=a[c],f+=b[0]*e[1]-b[1]*e[0];return Math.abs(f)}function q(a,b){function c(a){switch(a.type){case"GeometryCollection":a.geometries.forEach(c);break;case"Polygon":d(a.arcs);break;case"MultiPolygon":a.arcs.forEach(d)}}function d(a){a.forEach(function(b){b.forEach(function(b){(f[b=b<0?~b:b]||(f[b]=[])).push(a)})}),g.push(a)}function e(b){return p(m(a,{type:"Polygon",arcs:[b]}).coordinates[0])}var f={},g=[],h=[];return b.forEach(c),g.forEach(function(a){if(!a._){var b=[],c=[a];for(a._=1,h.push(b);a=c.pop();)b.push(a),a.forEach(function(a){a.forEach(function(a){f[a<0?~a:a].forEach(function(a){a._||(a._=1,c.push(a))})})})}}),g.forEach(function(a){delete a._}),{type:"MultiPolygon",arcs:h.map(function(b){var c,d=[];if(b.forEach(function(a){a.forEach(function(a){a.forEach(function(a){f[a<0?~a:a].length<2&&d.push(a)})})}),d=Z(a,d),(c=d.length)>1)for(var g,h,i=1,j=e(d[0]);i<c;++i)(g=e(d[i]))>j&&(h=d[0],d[0]=d[i],d[i]=h,j=g);return d})}}function r(a){var b=a[0],c=a[1],d=a[2];return Math.abs((b[0]-d[0])*(c[1]-b[1])-(b[0]-c[0])*(d[1]-b[1]))}function s(a){for(var b,c=-1,d=a.length,e=a[d-1],f=0;++c<d;)b=e,e=a[c],f+=b[0]*e[1]-b[1]*e[0];return Math.abs(f)/2}function t(a,b){return a[1][2]-b[1][2]}function u(a,b){if(c=a.length){if((b=+b)<=0||c<2)return a[0];if(b>=1)return a[c-1];var c,d=(c-1)*b,e=Math.floor(d),f=a[e],g=a[e+1];return f+(g-f)*(d-e)}}function v(a,b){return b-a}function w(a,b){if(!a.length)return 0;var c,d,e,f,g,h,i,j=0,k=a[0],l=k[0]*ma,m=(k[1]*ma+ka)/2,n=qa(m),o=sa(m);for(g=1,h=a.length;g<h;++g)k=a[g],c=l,l=k[0]*ma,d=l-c,m=(k[1]*ma+ka)/2,e=n,n=qa(m),f=o,o=sa(m),i=f*o,j+=pa(i*sa(d),e*n+i*qa(d));return j=2*(j>ja?j-ka:j<-ja?j+ka:j),b&&(j*=-1),j<0?j+la:j}function x(a){var b=a[0][0]*ma,c=a[0][1]*ma,d=qa(c),e=sa(c),f=a[1][0]*ma,g=a[1][1]*ma,h=qa(g),i=sa(g),j=a[2][0]*ma,k=a[2][1]*ma,l=qa(k),m=sa(k),n=y(b,d,e,f,h,i),o=y(f,h,i,j,l,m),p=y(j,l,m,b,d,e),q=(n+o+p)/2;return 4*oa(ta(ra(0,ua(q/2)*ua((q-n)/2)*ua((q-o)/2)*ua((q-p)/2))))}function y(a,b,c,d,e,f){var g=na(d-a),h=qa(g),i=sa(g),j=f*i,k=c*e-b*f*h,l=b*e+c*f*h;return pa(ta(j*j+k*k),l)}var z=function(a){function b(a){a&&j.hasOwnProperty(a.type)&&j[a.type](a)}function c(a){var b=a[0],c=a[1];b<f&&(f=b),b>h&&(h=b),c<g&&(g=c),c>i&&(i=c)}function d(a){a.forEach(c)}function e(a){a.forEach(d)}var f=1/0,g=1/0,h=-(1/0),i=-(1/0),j={GeometryCollection:function(a){a.geometries.forEach(b)},Point:function(a){c(a.coordinates)},MultiPoint:function(a){a.coordinates.forEach(c)},LineString:function(a){d(a.coordinates)},MultiLineString:function(a){a.coordinates.forEach(d)},Polygon:function(a){a.coordinates.forEach(d)},MultiPolygon:function(a){a.coordinates.forEach(e)}};for(var k in a)b(a[k]);return h>=f&&i>=g?[f,g,h,i]:void 0},A=function(a,b,c,d,e){function f(d){for(var f=b(d)&j,g=i[f],h=0;g!=e;){if(c(g,d))return!0;if(++h>=a)throw new Error("full hashset");g=i[f=f+1&j]}return i[f]=d,!0}function g(d){for(var f=b(d)&j,g=i[f],h=0;g!=e;){if(c(g,d))return!0;if(++h>=a)break;g=i[f=f+1&j]}return!1}function h(){for(var a=[],b=0,c=i.length;b<c;++b){var d=i[b];d!=e&&a.push(d)}return a}3===arguments.length&&(d=Array,e=null);for(var i=new d(a=1<<Math.max(4,Math.ceil(Math.log(a)/Math.LN2))),j=a-1,k=0;k<a;++k)i[k]=e;return{add:f,has:g,values:h}},B=function(a,b,c,d,e,f){function g(d,f){for(var g=b(d)&m,h=k[g],i=0;h!=e;){if(c(h,d))return l[g]=f;if(++i>=a)throw new Error("full hashmap");h=k[g=g+1&m]}return k[g]=d,l[g]=f,f}function h(d,f){for(var g=b(d)&m,h=k[g],i=0;h!=e;){if(c(h,d))return l[g];if(++i>=a)throw new Error("full hashmap");h=k[g=g+1&m]}return k[g]=d,l[g]=f,f}function i(d,f){for(var g=b(d)&m,h=k[g],i=0;h!=e;){if(c(h,d))return l[g];if(++i>=a)break;h=k[g=g+1&m]}return f}function j(){for(var a=[],b=0,c=k.length;b<c;++b){var d=k[b];d!=e&&a.push(d)}return a}3===arguments.length&&(d=f=Array,e=null);for(var k=new d(a=1<<Math.max(4,Math.ceil(Math.log(a)/Math.LN2))),l=new f(a),m=a-1,n=0;n<a;++n)k[n]=e;return{set:g,maybeSet:h,get:i,keys:j}},C=function(a,b){return a[0]===b[0]&&a[1]===b[1]},D=new ArrayBuffer(16),E=new Float64Array(D),F=new Uint32Array(D),G=function(a){E[0]=a[0],E[1]=a[1];var b=F[0]^F[1];return b=b<<5^b>>7^F[2]^F[3],2147483647&b},H=function(a){function b(a,b,c,d){if(o[c]!==a){o[c]=a;var e=p[c];if(e>=0){var f=q[c];e===b&&f===d||e===d&&f===b||(++s,r[c]=1)}else p[c]=b,q[c]=d}}function c(){for(var a=B(1.4*k.length,d,e,Int32Array,-1,Int32Array),b=new Int32Array(k.length),c=0,f=k.length;c<f;++c)b[c]=a.maybeSet(c,c);return b}function d(a){return G(k[a])}function e(a,b){return C(k[a],k[b])}var f,g,h,i,j,k=a.coordinates,l=a.lines,m=a.rings,n=c(),o=new Int32Array(k.length),p=new Int32Array(k.length),q=new Int32Array(k.length),r=new Int8Array(k.length),s=0;for(f=0,g=k.length;f<g;++f)o[f]=p[f]=q[f]=-1;for(f=0,g=l.length;f<g;++f){var t=l[f],u=t[0],v=t[1];for(i=n[u],j=n[++u],++s,r[i]=1;++u<=v;)b(f,h=i,i=j,j=n[u]);++s,r[j]=1}for(f=0,g=k.length;f<g;++f)o[f]=-1;for(f=0,g=m.length;f<g;++f){var w=m[f],x=w[0]+1,y=w[1];for(h=n[y-1],i=n[x-1],j=n[x],b(f,h,i,j);++x<=y;)b(f,h=i,i=j,j=n[x])}o=p=q=null;var z,D=A(1.4*s,G,C);for(f=0,g=k.length;f<g;++f)r[z=n[f]]&&D.add(k[z]);return D},I=function(a){var c,d,e,f=H(a),g=a.coordinates,h=a.lines,i=a.rings;for(d=0,e=h.length;d<e;++d)for(var j=h[d],k=j[0],l=j[1];++k<l;)f.has(g[k])&&(c={0:k,1:j[1]},j[1]=k,j=j.next=c);for(d=0,e=i.length;d<e;++d)for(var m=i[d],n=m[0],o=n,p=m[1],q=f.has(g[n]);++o<p;)f.has(g[o])&&(q?(c={0:o,1:m[1]},m[1]=o,m=m.next=c):(b(g,n,p,p-o),g[p]=g[n],q=!0,o=n));return a},J=function(a){function b(a){var b,c,f,g,h,i,j,k;if(f=q.get(b=m[a[0]]))for(j=0,k=f.length;j<k;++j)if(g=f[j],d(g,a))return a[0]=g[0],void(a[1]=g[1]);if(h=q.get(c=m[a[1]]))for(j=0,k=h.length;j<k;++j)if(i=h[j],e(i,a))return a[1]=i[0],void(a[0]=i[1]);f?f.push(a):q.set(b,[a]),h?h.push(a):q.set(c,[a]),r.push(a)}function c(a){var b,c,d,e,i;if(c=q.get(b=m[a[0]]))for(e=0,i=c.length;e<i;++e){if(d=c[e],f(d,a))return a[0]=d[0],void(a[1]=d[1]);if(g(d,a))return a[0]=d[1],void(a[1]=d[0])}if(c=q.get(b=m[a[0]+h(a)]))for(e=0,i=c.length;e<i;++e){if(d=c[e],f(d,a))return a[0]=d[0],void(a[1]=d[1]);if(g(d,a))return a[0]=d[1],void(a[1]=d[0])}c?c.push(a):q.set(b,[a]),r.push(a)}function d(a,b){var c=a[0],d=b[0],e=a[1],f=b[1];if(c-e!==d-f)return!1;for(;c<=e;++c,++d)if(!C(m[c],m[d]))return!1;return!0}function e(a,b){var c=a[0],d=b[0],e=a[1],f=b[1];if(c-e!==d-f)return!1;for(;c<=e;++c,--f)if(!C(m[c],m[f]))return!1;return!0}function f(a,b){var c=a[0],d=b[0],e=a[1],f=b[1],g=e-c;if(g!==f-d)return!1;for(var i=h(a),j=h(b),k=0;k<g;++k)if(!C(m[c+(k+i)%g],m[d+(k+j)%g]))return!1;return!0}function g(a,b){var c=a[0],d=b[0],e=a[1],f=b[1],g=e-c;if(g!==f-d)return!1;for(var i=h(a),j=g-h(b),k=0;k<g;++k)if(!C(m[c+(k+i)%g],m[f-(k+j)%g]))return!1;return!0}function h(a){for(var b=a[0],c=a[1],d=b,e=d,f=m[d];++d<c;){var g=m[d];(g[0]<f[0]||g[0]===f[0]&&g[1]<f[1])&&(e=d,f=g)}return e-b}var i,j,k,l,m=a.coordinates,n=a.lines,o=a.rings,p=n.length+o.length;for(delete a.lines,delete a.rings,k=0,l=n.length;k<l;++k)for(i=n[k];i=i.next;)++p;for(k=0,l=o.length;k<l;++k)for(j=o[k];j=j.next;)++p;var q=B(2*p*1.4,G,C),r=a.arcs=[];for(k=0,l=n.length;k<l;++k){i=n[k];do b(i);while(i=i.next)}for(k=0,l=o.length;k<l;++k)if(j=o[k],j.next){do b(j);while(j=j.next)}else c(j);return a},K=function(a){for(var b=a.arcs,c=-1,d=b.length;++c<d;)for(var e,f,g=b[c],h=0,i=g.length,j=g[0],k=j[0],l=j[1];++h<i;)j=g[h],e=j[0],f=j[1],g[h]=[e-k,f-l],k=e,l=f;return a},L=function(a){function b(a){a&&j.hasOwnProperty(a.type)&&j[a.type](a)}function c(a){for(var b=0,c=a.length;b<c;++b)i[++f]=a[b];var d={0:f-c+1,1:f};return g.push(d),d}function d(a){for(var b=0,c=a.length;b<c;++b)i[++f]=a[b];var d={0:f-c+1,1:f};return h.push(d),d}function e(a){return a.map(d)}var f=-1,g=[],h=[],i=[],j={GeometryCollection:function(a){a.geometries.forEach(b)},LineString:function(a){a.arcs=c(a.coordinates),delete a.coordinates},MultiLineString:function(a){a.arcs=a.coordinates.map(c),delete a.coordinates},Polygon:function(a){a.arcs=a.coordinates.map(d),delete a.coordinates},MultiPolygon:function(a){a.arcs=a.coordinates.map(e),delete a.coordinates}};for(var k in a)b(a[k]);return{type:"Topology",coordinates:i,lines:g,rings:h,objects:a}},M=function(a){var b;for(b in a)a[b]=d(a[b]);return a},N={Feature:e,FeatureCollection:function(a){return a.type="GeometryCollection",a.geometries=a.features,a.features.forEach(e),delete a.features,a}},O={GeometryCollection:function(a){for(var b=a.geometries,c=-1,d=b.length;++c<d;)b[c]=f(b[c])},MultiPoint:function(a){a.coordinates.length?a.coordinates.length<2&&(a.type="Point",a.coordinates=a.coordinates[0]):(a.type=null,delete a.coordinates)},LineString:function(a){a.coordinates.length||(a.type=null,delete a.coordinates)},MultiLineString:function(a){for(var b=a.coordinates,c=0,d=0,e=b.length;c<e;++c){var f=b[c];f.length&&(b[d++]=f)}d?d<2?(a.type="LineString",a.coordinates=b[0]):a.coordinates.length=d:(a.type=null,delete a.coordinates)},Polygon:function(a){for(var b=a.coordinates,c=0,d=0,e=b.length;c<e;++c){var f=b[c];f.length&&(b[d++]=f)}d?a.coordinates.length=d:(a.type=null,delete a.coordinates)},MultiPolygon:function(a){for(var b=a.coordinates,c=0,d=0,e=b.length;c<e;++c){for(var f=b[c],g=0,h=0,i=f.length;g<i;++g){var j=f[g];j.length&&(f[h++]=j)}h&&(f.length=h,b[d++]=f)}d?d<2?(a.type="Polygon",a.coordinates=b[0]):b.length=d:(a.type=null,delete a.coordinates)}},P=function(a,b,c){function d(a){return a[0]=Math.round((a[0]-g)*k),a[1]=Math.round((a[1]-h)*l),a}function e(a){for(var b,c,e,f=0,g=1,h=a.length,i=d(a[0]),j=i[0],k=i[1];++f<h;)i=d(a[f]),c=i[0],e=i[1],c===j&&e===k||(b=a[g++],b[0]=j=c,b[1]=k=e);a.length=g}function f(a){a&&m.hasOwnProperty(a.type)&&m[a.type](a)}var g=b[0],h=b[1],i=b[2],j=b[3],k=i-g?(c-1)/(i-g):1,l=j-h?(c-1)/(j-h):1,m={GeometryCollection:function(a){a.geometries.forEach(f)},Point:function(a){d(a.coordinates)},MultiPoint:function(a){a.coordinates.forEach(d)},LineString:function(a){var b=a.coordinates;e(b),b.length<2&&(b[1]=b[0])},MultiLineString:function(a){for(var b=a.coordinates,c=0,d=b.length;c<d;++c){var f=b[c];e(f),f.length<2&&(f[1]=f[0])}},Polygon:function(a){for(var b=a.coordinates,c=0,d=b.length;c<d;++c){var f=b[c];for(e(f);f.length<4;)f.push(f[0])}},MultiPolygon:function(a){for(var b=a.coordinates,c=0,d=b.length;c<d;++c)for(var f=b[c],g=0,h=f.length;g<h;++g){var i=f[g];for(e(i);i.length<4;)i.push(i[0])}}};for(var n in a)f(a[n]);return{scale:[1/k,1/l],translate:[g,h]}},Q=function(a,b){function c(a){a&&m.hasOwnProperty(a.type)&&m[a.type](a)}function d(a){var b=[];do{var c=l.get(a);b.push(a[0]<a[1]?c:~c)}while(a=a.next);return b}function e(a){return a.map(d)}var f=z(M(a)),i=b>0&&f&&P(a,f,b),j=J(I(L(a))),k=j.coordinates,l=B(1.4*j.arcs.length,g,h);a=j.objects,j.bbox=f,j.arcs=j.arcs.map(function(a,b){return l.set(a,b),k.slice(a[0],a[1]+1)}),delete j.coordinates,k=null;var m={GeometryCollection:function(a){a.geometries.forEach(c)},LineString:function(a){a.arcs=d(a.arcs)},MultiLineString:function(a){a.arcs=a.arcs.map(d)},Polygon:function(a){a.arcs=a.arcs.map(d)},MultiPolygon:function(a){a.arcs=a.arcs.map(e)}};for(var n in a)c(a[n]);return i&&(j.transform=i,K(j)),j},R=function(a){function b(a){switch(a.type){case"GeometryCollection":a.geometries.forEach(b);break;case"LineString":c(a.arcs);break;case"MultiLineString":a.arcs.forEach(c);break;case"Polygon":a.arcs.forEach(c);break;case"MultiPolygon":a.arcs.forEach(d)}}function c(a){for(var b=0,c=a.length;b<c;++b){var d,e=a[b],j=e<0&&(e=~e,!0);null==(d=i[e])&&(i[e]=d=++h,g[d]=f[e]),a[b]=j?~d:d}}function d(a){a.forEach(c)}var e,f=a.arcs,g=a.arcs=[],h=-1,i=new Array(f.length);for(e in a.objects)b(a.objects[e]);return a},S=function(a,b){function c(a){switch(a.type){case"Polygon":a.arcs=d(a.arcs),a.arcs||(a.type=null,delete a.arcs);break;case"MultiPolygon":a.arcs=a.arcs.map(d).filter(j),a.arcs.length||(a.type=null,delete a.arcs);break;case"GeometryCollection":a.geometries.forEach(c),a.geometries=a.geometries.filter(k),a.geometries.length||(a.type=null,delete a.geometries)}}function d(a){return a.length&&e(a[0])?[a.shift()].concat(a.filter(f)):null}function e(a){return b(a,!1)}function f(a){return b(a,!0)}var g;null==b&&(b=i);for(g in a.objects)c(a.objects[g]);return R(a)},T=function(a){function b(a){switch(a.type){case"GeometryCollection":a.geometries.forEach(b);break;case"Polygon":c(a.arcs);break;case"MultiPolygon":a.arcs.forEach(c)}}function c(a){for(var b=0,c=a.length;b<c;++b,++f)for(var d=a[b],g=0,h=d.length;g<h;++g){var i=d[g];i<0&&(i=~i);var j=e[i];j>=0&&j!==f?e[i]=-1:e[i]=f}}var d,e={},f=0;for(d in a.objects)b(a.objects[d]);return function(a){for(var b,c=0,d=a.length;c<d;++c)if(b=a[c],e[b<0?~b:b]<0)return!0;return!1}},U=function(a){return a},V=function(a){if(null==(b=a.transform))return U;var b,c,d,e=b.scale[0],f=b.scale[1],g=b.translate[0],h=b.translate[1];return function(a,b){return b||(c=d=0),a[0]=(c+=a[0])*e+g,a[1]=(d+=a[1])*f+h,a}},W=function(a){function b(a){h[0]=a[0],h[1]=a[1],g(h),h[0]<i&&(i=h[0]),h[0]>k&&(k=h[0]),h[1]<j&&(j=h[1]),h[1]>l&&(l=h[1])}function c(a){switch(a.type){case"GeometryCollection":a.geometries.forEach(c);break;case"Point":b(a.coordinates);break;case"MultiPoint":a.coordinates.forEach(b)}}var d=a.bbox;if(!d){var e,f,g=V(a),h=new Array(2),i=1/0,j=i,k=-i,l=-i;a.arcs.forEach(function(a){for(var b=-1,c=a.length;++b<c;)e=a[b],h[0]=e[0],h[1]=e[1],g(h,b),h[0]<i&&(i=h[0]),h[0]>k&&(k=h[0]),h[1]<j&&(j=h[1]),h[1]>l&&(l=h[1])});for(f in a.objects)c(a.objects[f]);d=a.bbox=[i,j,k,l]}return d},X=function(a,b){for(var c,d=a.length,e=d-b;e<--d;)c=a[e],a[e++]=a[d],a[d]=c},Y=function(a,b){return"GeometryCollection"===b.type?{type:"FeatureCollection",features:b.geometries.map(function(b){return l(a,b)})}:l(a,b)},Z=function(a,b){function c(b){var c,d=a.arcs[b<0?~b:b],e=d[0];return a.transform?(c=[0,0],d.forEach(function(a){c[0]+=a[0],c[1]+=a[1]})):c=d[d.length-1],b<0?[c,e]:[e,c]}function d(a,b){for(var c in a){var d=a[c];delete b[d.start],delete d.start,delete d.end,d.forEach(function(a){e[a<0?~a:a]=1}),h.push(d)}}var e={},f={},g={},h=[],i=-1;return b.forEach(function(c,d){var e,f=a.arcs[c<0?~c:c];f.length<3&&!f[1][0]&&!f[1][1]&&(e=b[++i],b[i]=c,b[d]=e)}),b.forEach(function(a){var b,d,e=c(a),h=e[0],i=e[1];if(b=g[h])if(delete g[b.end],b.push(a),b.end=i,d=f[i]){delete f[d.start];var j=d===b?b:b.concat(d);f[j.start=b.start]=g[j.end=d.end]=j}else f[b.start]=g[b.end]=b;else if(b=f[i])if(delete f[b.start],b.unshift(a),b.start=h,d=g[h]){delete g[d.end];var k=d===b?b:d.concat(b);f[k.start=d.start]=g[k.end=b.end]=k}else f[b.start]=g[b.end]=b;else b=[a],f[b.start=h]=g[b.end=i]=b}),d(g,f),d(f,g),b.forEach(function(a){e[a<0?~a:a]||h.push([a])}),h},$=function(a){return m(a,n.apply(this,arguments))},_=function(a){return m(a,q.apply(this,arguments))},aa=function(a,b){for(var c=0,d=a.length;c<d;){var e=c+d>>>1;a[e]<b?c=e+1:d=e}return c},ba=function(a){function b(a,b){a.forEach(function(a){a<0&&(a=~a);var c=e[a];c?c.push(b):e[a]=[b]})}function c(a,c){a.forEach(function(a){b(a,c)})}function d(a,b){"GeometryCollection"===a.type?a.geometries.forEach(function(a){d(a,b)}):a.type in g&&g[a.type](a.arcs,b)}var e={},f=a.map(function(){return[]}),g={LineString:b,MultiLineString:c,Polygon:c,MultiPolygon:function(a,b){a.forEach(function(a){c(a,b)})}};a.forEach(d);for(var h in e)for(var i=e[h],j=i.length,k=0;k<j;++k)for(var l=k+1;l<j;++l){var m,n=i[k],o=i[l];(m=f[n])[h=aa(m,o)]!==o&&m.splice(h,0,o),(m=f[o])[h=aa(m,n)]!==n&&m.splice(h,0,n)}return f},ca=function(a,b){function c(a){a[0]=Math.round((a[0]-g)/h),a[1]=Math.round((a[1]-i)/j)}function d(a){switch(a.type){case"GeometryCollection":a.geometries.forEach(d);break;case"Point":c(a.coordinates);break;case"MultiPoint":a.coordinates.forEach(c)}}if(!((b=Math.floor(b))>=2))throw new Error("n must be ≥2");if(a.transform)throw new Error("already quantized");var e,f=W(a),g=f[0],h=(f[2]-g)/(b-1)||1,i=f[1],j=(f[3]-i)/(b-1)||1;a.arcs.forEach(function(a){for(var b,c,d,e=1,f=1,k=a.length,l=a[0],m=l[0]=Math.round((l[0]-g)/h),n=l[1]=Math.round((l[1]-i)/j);e<k;++e)l=a[e],c=Math.round((l[0]-g)/h),d=Math.round((l[1]-i)/j),c===m&&d===n||(b=a[f++],b[0]=c-m,m=c,b[1]=d-n,n=d);f<2&&(b=a[f++],b[0]=0,b[1]=0),a.length=f});for(e in a.objects)d(a.objects[e]);return a.transform={scale:[h,j],translate:[g,i]},a},da=function(a){if(null==(b=a.transform))return U;var b,c,d,e=b.scale[0],f=b.scale[1],g=b.translate[0],h=b.translate[1];return function(a,b){b||(c=d=0);var i=Math.round((a[0]-g)/e),j=Math.round((a[1]-h)/f);return a[0]=i-c,c=i,a[1]=j-d,d=j,a}},ea=function(a,b,c){return b=null==b?Number.MIN_VALUE:+b,null==c&&(c=s),function(d,e){return c(Y(a,{type:"Polygon",arcs:[d]}).geometry.coordinates[0],e)>=b}},fa=function(){function a(a,b){for(;b>0;){var c=(b+1>>1)-1,e=d[c];if(t(a,e)>=0)break;d[e._=b]=e,d[a._=b=c]=a}}function b(a,b){for(;;){var c=b+1<<1,f=c-1,g=b,h=d[g];if(f<e&&t(d[f],h)<0&&(h=d[g=f]),c<e&&t(d[c],h)<0&&(h=d[g=c]),g===b)break;d[h._=b]=h,d[a._=b=g]=a}}var c={},d=[],e=0;return c.push=function(b){return a(d[b._=e]=b,e++),e},c.pop=function(){if(!(e<=0)){var a,c=d[0];return--e>0&&(a=d[e],b(d[a._=0]=a,0)),c}},c.remove=function(c){var f,g=c._;if(d[g]===c)return g!==--e&&(f=d[e],(t(f,c)<0?a:b)(d[f._=g]=f,g)),g},c},ga=function(a,b){function c(a){f.remove(a),a[1][2]=b(a),f.push(a)}var d=V(a),e=da(a),f=fa();return null==b&&(b=r),a.arcs.forEach(function(a){var g,h,i,j=[],k=0;for(a.forEach(d),h=1,i=a.length-1;h<i;++h)g=a.slice(h-1,h+2),g[1][2]=b(g),j.push(g),f.push(g);for(a[0][2]=a[i][2]=1/0,h=0,i=j.length;h<i;++h)g=j[h],g.previous=j[h-1],g.next=j[h+1];for(;g=f.pop();){var l=g.previous,m=g.next;g[1][2]<k?g[1][2]=k:k=g[1][2],l&&(l.next=m,l[2]=g[2],c(l)),m&&(m.previous=l,m[0]=g[0],c(m))}a.forEach(e)}),a},ha=function(a,b){var c=[];return a.arcs.forEach(function(a){a.forEach(function(a){isFinite(a[2])&&c.push(a[2])})}),c.length&&u(c.sort(v),b)},ia=function(a,b){return b=null==b?Number.MIN_VALUE:+b,a.arcs.forEach(a.transform?function(a){for(var c,d,e=0,f=0,g=-1,h=-1,i=a.length;++g<i;)c=a[g],c[2]>=b?(d=a[++h],d[0]=c[0]+e,d[1]=c[1]+f,e=f=0):(e+=c[0],f+=c[1]);a.length=++h}:function(a){for(var c,d=-1,e=-1,f=a.length;++d<f;)c=a[d],c[2]>=b&&(a[++e]=c);a.length=++e}),a.arcs.forEach(a.transform?function(a){var b=0,c=0,d=a.length,e=a[0];for(e.length=2;++b<d;)e=a[b],e.length=2,(e[0]||e[1])&&(a[++c]=e);a.length=(c||1)+1}:function(a){var b,c,d=0,e=0,f=a.length,g=a[0],h=g[0],i=g[1];for(g.length=2;++d<f;)g=a[d],b=g[0],c=g[1],g.length=2,h===b&&i===c||(a[++e]=g,h=b,i=c);a.length=(e||1)+1}),a},ja=Math.PI,ka=2*ja,la=4*ja,ma=ja/180,na=Math.abs,oa=Math.atan,pa=Math.atan2,qa=Math.cos,ra=Math.max,sa=Math.sin,ta=Math.sqrt,ua=Math.tan;a.topology=Q,a.filter=S,a.filterAttached=T,a.filterWeight=ea,a.planarRingArea=s,a.planarTriangleArea=r,a.presimplify=ga,a.quantile=ha,a.simplify=ia,a.sphericalRingArea=w,a.sphericalTriangleArea=x,a.bbox=W,a.feature=Y,a.merge=_,a.mergeArcs=q,a.mesh=$,a.meshArcs=n,a.neighbors=ba,a.quantize=ca,a.transform=V,a.untransform=da,Object.defineProperty(a,"__esModule",{value:!0})}),function(a){function b(a){var b,d=a.split(",").map(function(a){return a.trim()}),e=d[0],f=d.slice(1),g=/(\[*?[^%]*?%[a-z0-9\.]+[^%]*?\]?)/g,h=[];c('fmt "%s"',e),c("keys = %s",f);for(var i;null!==(b=g.exec(e));)c("%j",b),h.push(b[1]),i=g.lastIndex;if(c("%d,%d",e.length,i),e.length>i&&(h[h.length-1]+=e.substring(i)),h=h.map(function(a){return/^\[.*\]$/.test(a)?{fmt:a.slice(1,a.length-1),opt:!0}:{fmt:a}}),h.forEach(function(a,b){c('[%d] = "%j"',b,a)}),h.length!==f.length)throw new Error("format to key length mismatch");this.$keys=f,this.$fmts=h}b.prototype.format=function(a){var b=this.$keys,e=this.$fmts,f=b.reduce(function(b,c,d){var f=a[c],g=null===f||"undefined"==typeof f,h=e[d];if(g&&!h.opt)throw new Error("missing required key "+c);return g||(b.fmt+=h.fmt,b.args.push(f)),b},{fmt:"",args:[]});return c("%j",f),d.apply(null,[f.fmt].concat(f.args))};var c,d;"undefined"!=typeof module&&module.exports?(module.exports=b,c=require("debug")("property-formatter"),d=require("sprintf-js").sprintf):"undefined"!=typeof a&&(a.PropertyFormatter=b,c=function(){},d=a.sprintf)}("undefined"==typeof window?this:window),angular.module("app-container-geo.admin",["app-container-file","ui.bootstrap"]).directive("propertyFormatValidate",["$log","$q","$parse","$window",function(a,b,c,d){return{require:"ngModel",link:function(e,f,g,h){var i=d.PropertyFormatter,j=c(g.propertyFormatValidate)(e);a.debug("propertyFormatValidate.exampleProperties",j),j&&(h.$asyncValidators.propertyFormat=function(c,d){a.debug('modelValue="'+c+'" newValue="'+d+'"');var e,f=b.defer();if(d)try{e=new i(d).format(j),a.debug("format string ok",e),f.resolve(!0)}catch(b){a.debug("format error",b),f.reject()}else f.reject();return f.promise})}}}]).directive("layerNameValidate",["$log","$q","$timeout","Layer",function(a,b,c,d){return{require:"ngModel",link:function(e,f,g,h){var i;h.$asyncValidators.layerNameinUse=function(e,f){a.debug('modelValue="'+e+'" newValue="'+f+'"'),i&&(c.cancel(i),i=void 0);var g=b.defer();return f?i=c(function(){d.query({$filter:"name eq '"+f+"'"},function(a){0===a.list.length?g.resolve(!0):g.reject()})},500):g.reject(),g.promise}}}}]).directive("layerCreateInputForm",[function(){return{restrict:"C",templateUrl:"js/admin/layer-create-input-form.html"}}]).directive("exampleLayerProperties",[function(){return{restrict:"AEC",template:'<h4>Example Feature Properties <i uib-popover-template="\'js/admin/layer-create-eprops-popover.html\'" popover-placement="auto bottom" class="fa fa-info-circle" aria-hidden="true"></i></h4><table class="table table-striped table-condensed"><tr><th>Property</th><th>Value</th><th>Type</th><th></th></tr><tr ng-repeat="(prop,pinfo) in preResults.examplePropertiesAnnotated"><td>{{prop}}</td><td>{{pinfo.value}}</td><td>{{pinfo.type}}</td><td><i uib-tooltip="Unique" ng-if="pinfo.unique" class="fa fa-key" aria-hidden="true"></i></td></tr></table>'}}]).controller("LayerCreateCtrl",["$scope","$log","$timeout","$mdDialog","WebSocketConnection","File","NotificationService",function(a,b,c,d,e,f,g){var h,i,j=a.STATES={HANDSHAKE:"HANDSHAKE",FILE_UPLOAD:"FILE_UPLOAD",PRE_PROCESS_RUNNING:"PRE_PROCESS_RUNNING",USER_INPUT:"USER_INPUT",POST_PROCESS_RUNNING:"POST_PROCESS_RUNNING",COMPLETE:"COMPLETE"};a.infoMessages=[],a.dismiss=function(){function c(){d.cancel()}a.uploadedFile?(b.debug("dismiss, cleaning up",a.uploadedFile),a.uploadedFile.$remove({id:a.uploadedFile._id},c,g.addError)):c()};var k=new e("geo/initLayer",function(){b.debug("connection to geo/initLayer established."),a.$on("$destroy",k.connectionCloser()),k.onMessage(function(c){a.$apply(function(){switch(b.debug("Message (current state:"+h+")",c),c.key){case"state":h=a.STATE=j[c.toState],i=a.STATE_DATA=c.data;break;case"error":b.error(c.data);break;case"info":b.debug("info: ",c.data),a.infoMessages.splice(0,0,{cls:/^FAILED/.test(c.data)||/^ERROR/.test(c.data)?"error":"info",text:c.data});break;case"complete":break;default:b.error("unexpected message")}})}),c(function(){h=a.STATE=j.HANDSHAKE},1e3)});a.$watch("STATE",function(c){if(c)switch(b.debug("Entered state ",c),c){case j.HANDSHAKE:k.send({key:"state",currentState:j.HANDSHAKE});break;case j.USER_INPUT:a.preResults=i,a.userInput={};break;case j.COMPLETE:delete a.uploadedFile,a.dismiss=function(){d.hide()}}}),a.fileResource=f,a.$watch("fileToUpload",function(b){console.log("fileToUpload",b),b&&b.file&&b.$save&&(b.metadata={type:"layerSource"},b.$save(function(b){a.uploadedFile=b,delete a.fileToUpload}))}),a.$watch("uploadedFile",function(c){c&&(b.debug("uploadedFile",c),"application/zip"===c.contentType||/\.ndjson$/.test(c.filename)?(b.debug("Notifying server of new file, start pre-processing"),k.send({key:"state",currentState:h,data:c._id})):(b.debug("Unacceptable file type, deleting."),g.addError({statusText:c.fileName+" is not a zip or ndjson file."}),c.$remove({id:c._id},function(){b.debug("removed "+c.fileName),delete a.uploadedFile},g.addError)))}),a.add=function(){k.send({key:"state",currentState:h,data:a.userInput})}}]).directive("mapLayerAdministration",["$log","$mdDialog","$typeAheadFinder","uiGmapGoogleMapApi","uiGmapIsReady","MapLayerService","NotificationService","Layer","DynamicMapLayer",function(a,b,c,d,e,f,g,h,i){return{restrict:"E",templateUrl:"js/admin/map-layer-administration.html",scope:{adminModeChange:"&"},link:function(f){f.selection={},f.findLayer=c(h,function(a){return"contains(name,'"+a+"')"}),d.then(function(c){e.promise(1).then(function(c){function d(a){f.activeMapLayer&&f.activeMapLayer.remove(),delete f.activeMapLayer,delete f.displayedOfTotal,a&&delete f.selection.layer}function e(a){d(),a&&(f.activeMapLayer=new i(f,a).map(h).changeListener(function(a){a.totalFeatureCount().then(function(b){f.displayedOfTotal=a.featureCount()+"/"+b,a.featureCount()===a.maxFeatures()?f.limitToast=g.addError("Features limit reached "+f.displayedOfTotal+".  Zoom in or pan to limit bounds."):f.limitToast&&(g.hideToast(),delete f.limitToast)})}).add())}var h=c[0].map;a.debug("map-layer-administration: ready"),f.$watch("enabled",function(b){a.debug("map-layer-administration: "+(b?"on":"off")),(f.adminModeChange||angular.noop)({mode:b}),d(!b)}),f.$watch("selection.layer",function(b){a.debug("map-layer-administration: layer",b),e(b)}),f.createLayer=function(){b.show({templateUrl:"js/admin/layer-create.html",controller:"LayerCreateCtrl",fullscreen:!0,clickOutsideToClose:!1,escapeToClose:!1}).then(e,angular.noop)},f.removeLayer=function(a,c){b.show(b.confirm().title("Are you sure you want to delete "+a.name+"?").textContent("This cannot be undone.").ariaLabel("Delete map layer").ok("Yes").cancel("No")).then(function(){d(!0),a.$remove({id:a._id},function(){g.addInfo("Removed "+a.name)},g.addError)},angular.noop)}})})}}}]),angular.module("app-container-geo",["app-container-common","templates-app-container-geo","app-container-geo.admin"]).service("Layer",["$appService","$q","$http",function(a,b,c){var d=a("geo/layer/:id");return d.prototype.featureCount=function(){var a=this;return a.$featureCount||(a.$featureCount=b.defer(),c.get(a._links.features+"/count").then(function(b){a.$featureCount.resolve(b.data)},angular.noop)),a.$featureCount.promise},d.prototype.topojson=function(){var a=this,d=b.defer();return c.get(a._links.topojson).then(function(a){d.resolve(a.data)},d.reject),d.promise},d}]).service("Feature",["$appService",function(a){var b=a("geo/feature/:id");return b}]).factory("MapLayerService",["$q","$http","$log","$compile","$timeout","MapLayer","Feature",function(a,b,c,d,e,f,g){
return{getForPoint:function(b,c){var d=a.defer();return g.get({id:"intersects",coordinates:[c,b].join(",")},function(a){d.resolve(new f(a.list))}),d.promise},getForFeature:function(b){var c=a.defer();return g.get({id:b},function(a){c.resolve(new f([a]))}),c.promise},getForLayer:function(c,d){var e=a.defer();return b({method:"GET",url:c._links.topojson,params:angular.extend({q:"1e4"},d||{})}).then(function(a){var b=a.data,d=topojson.feature(b,b.objects.layer);e.resolve(new f(d.features.map(function(a){var b=angular.extend({},a.properties._featureProps);return delete a.properties._featureProps,b.data=a,b._layer=c,b})))}),e.promise},featureClickProperties:function(a,b){var f;return function(g){a.$apply(function(){c.debug("feature click."),a.$iwFeature=g.feature.getMapFeature();var h=d('<property-feature-info-window feature="$iwFeature"></property-feature-info-window>')(a);f||(f=new google.maps.InfoWindow({maxWidth:750,content:"temporary"})),e(function(){f.setContent(h.html()),f.setPosition(g.latLng),f.open(b)})})}},boundsToCoords:function(a){function b(a){f.push(a.lng()),f.push(a.lat())}var d=a.getNorthEast(),e=a.getSouthWest(),f=[];return b(e),b(new google.maps.LatLng(d.lat(),e.lng())),b(d),b(new google.maps.LatLng(e.lat(),d.lng())),c.debug("boundsToCoords",a,f),f}}}]).factory("MapFeature",["$log","Layer","Feature",function(a,b,c){var d=function(a,b){this.$feature=a,this.$layer=b,this.$isOn=!0;var c=this,d=this.$properties={};a.forEachProperty(function(a,b){d[b]=a}),a.getMapFeature=function(){return c}};return d.prototype.getBounds=function(){if(!this.$bounds){var a=this.$bounds=new google.maps.LatLngBounds,b=this.$feature.getGeometry(),c=b.getType();if(c&&/Polygon/.test(c)){var d,e,f=b.getArray(),g="Polygon"===c?f:f.reduce(function(a,b){return a.push(b.getArray()[0]),a},[]);for(d=0;d<g.length;d++){var h=g[d].getArray();for(e=0;e<h.length;e++)a.extend(new google.maps.LatLng(h[e].lat(),h[e].lng()))}}}return this.$bounds},d.prototype.$area=function(){var a=this.getBounds(),b=a.getNorthEast(),c=a.getSouthWest();return Math.abs(b.lat()-c.lat())*Math.abs(b.lng()-c.lng())},d.prototype.fit=function(){this.$layer.map().fitBounds(this.getBounds())},d.prototype.on=function(){this.$isOn||(this.$layer.map().data.add(this.$feature),this.$isOn=!0)},d.prototype.off=function(){this.$isOn&&(this.$layer.map().data.remove(this.$feature),this.$isOn=!1)},d.prototype.isOn=function(){return this.$isOn},d.prototype.toggle=function(){return this[this.isOn()?"off":"on"](),this.isOn()},d.prototype.properties=function(){return this.$properties},d.prototype.name=function(){return this.$properties.$featureName},d.prototype.id=function(){return this.$properties.$featureId},d.prototype.layerId=function(){return this.$properties.$layerId},d.prototype.layerName=function(){return this.$properties.$layerName},d.prototype.getFeatureResource=function(){var a=this;return a.$featureResource||(a.$featureResource=c.get({id:a.id()}),a.$featureResource.$promise.then(function(b){b.getMapFeature=function(){return a}})),a.$featureResource.$promise},d.prototype.getLayerResource=function(){var a=this;return a.$layerResource||(a.$layerResource=b.get({id:a.layerId()}),a.$layerResource.$promise.then(function(b){b.getMapFeature=function(){return a}})),a.$layerResource.$promise},d}]).factory("MapLayer",["$log","MapFeature",function(a,b){var c=function(a){(this.$features=a||[]).forEach(function(a){var b=a.data.properties;b.$featureName=a.featureName,b.$layerName=a._layer.name,b.$layerId=a._layer._id,b.$featureId=a._id})};return c.COLOR_SCALE=d3.scaleOrdinal(d3.schemeCategory20),c.BASE_STYLE={strokeColor:"#ffffff",strokeOpacity:null,strokeWeight:1,fillColor:"#aaaaaa",fillOpacity:null,zIndex:0,clickable:!0},c.prototype.map=function(a){return arguments.length?(this.$map=a,this):this.$map},c.prototype.geoJson=function(){return{type:"FeatureCollection",features:this.$features.map(function(a){return a.data})}},c.prototype.add=function(){var d,e=this,f=e.map();if(f&&!e.$mapFeatures){d=f.data.addGeoJson(e.geoJson()),e.$mapFeatures=d.map(function(a,d){return a.setProperty("$style",angular.extend({},c.BASE_STYLE,{fillColor:c.COLOR_SCALE(d)})),new b(a,e)});var g=Date.now();e.$mapFeatures.sort(function(a,b){return b.$area()-a.$area()}),e.$mapFeatures.forEach(function(a,b){var c=a.$feature.getProperty("$style");c.zIndex=b}),a.debug("stacking order calculated in "+(Date.now()-g)+"ms"),f.data.setStyle(function(a){return a.getProperty("$style")})}return e},c.prototype.fit=function(){return this.$mapFeatures&&this.$mapFeatures.length&&this.$mapFeatures[0].fit(),this},c.prototype.features=function(){return this.$mapFeatures||[]},c.prototype.remove=function(){return this.features().forEach(function(a){a.off()}),this},c}]).factory("DynamicMapLayer",["$log","$http","$timeout","MapLayer","MapFeature","Feature",function(a,b,c,d,e,f){var g=function(a,b){d.call(this,[]),this.$scope=a,this.$layerResource=b,this.$mapInitialized=!1,this.$top=500,this.$totalFeatures=b.featureCount()};return g.prototype=new d([]),g.prototype.maxFeatures=function(a){return arguments.length?(this.$top=a,this):this.$top},g.prototype.totalFeatureCount=function(){return this.$totalFeatures},g.prototype.add=function(){var b=this,c=b.map();return b.$mapInitialized||b.totalFeatureCount().then(function(d){d<b.maxFeatures()?(a.debug("DynamicMapLayer: layer has less than "+b.maxFeatures()+" loading all features."),b.$layerResource.topojson().then(function(a){b.boundsResponse({add:a})})):(a.debug("DynamicMapLayer: layer has more than "+b.maxFeatures()+" loaded features will change based on map bounds."),b.$boundsListener=c.addListener("bounds_changed",function(){b.boundsChanged()}),b.boundsChanged())}),b},g.prototype.fit=function(){},g.prototype.remove=function(){var b,c=this,d=c.map();if(c.$mapFeatures)for(b in c.$mapFeatures)c.$mapFeatures[b].off();delete c.$mapFeatures,d&&c.$boundsListener&&(c.$boundsListener.remove(),a.debug("DynamicMapLayer: no longer listening for bounds_changed")),delete c.$boundsListener,c.$mapInitialized=!1},g.prototype.boundsChanged=function(){var d=this;d.$boundsTimer&&c.cancel(d.$boundsTimer),d.$boundsTimer=c(function(){var c=d.map(),e=c.getBounds(),h=g.boundsToCoords(e),i={$filter:"_layer eq '"+d.$layerResource._id+"'",$top:d.$top,coordinates:h.join(","),q:1e4};d.$mapInitialized||(i.$reset=!0),a.debug("DynamicMapLayer.bounds_changed",e,i),b.post(f.$basePath+"/featureBounds",null,{params:i}).then(function(b){a.debug("success",b),d.boundsResponse(b.data)},function(b){a.debug("error",b)})},500)},g.prototype.boundsResponse=function(b){var c,f=this,g=f.map(),h=0;f.$mapFeatures=f.$mapFeatures||{},f.$mapInitialized=!0,b.drop&&b.drop.length&&(a.debug("DynamicMapLayer: dropping "+b.drop.length+" features"),b.drop.forEach(function(b){f.$mapFeatures[b]?(f.$mapFeatures[b].off(),delete f.$mapFeatures[b]):a.warn("instructed to drop feature with id "+b+" that is not on the map.")})),b.add&&(c=topojson.feature(b.add,b.add.objects.layer),a.debug("DynamicMapLayer: geoJson",c),a.debug("DynamicMapLayer: adding "+c.features.length+" features"),c.features.forEach(function(a){var b=a.properties;b._featureProps&&(b.$featureName=b._featureProps.featureName,b.$featureId=b._featureProps._id,b.$layerName=f.$layerResource.name,b.$layerId=f.$layerResource._id),delete b._featureProps}),g.data.addGeoJson(c),g.data.forEach(function(a){a.setProperty("$style",angular.extend({},d.BASE_STYLE,{fillColor:d.COLOR_SCALE(h++)}));var b=a.getProperty("$featureId");f.$mapFeatures[b]||(f.$mapFeatures[b]=new e(a,f))}),g.data.setStyle(function(a){return a.getProperty("$style")}),a.debug("DynamicMapLayer: map has "+h+" features currently loaded.")),f.$featureCount=0,g.data.forEach(function(){f.$featureCount++}),a.debug("DynamicMapLayer: map has "+f.$featureCount+" features currently loaded.");var i=f.changeListener();i&&i(f)},g.prototype.featureCount=function(){return this.$featureCount||0},g.prototype.changeListener=function(a){return arguments.length?(this.$changeListener=a,this):this.$changeListener},g.boundsToCoords=function(b){function c(a){h.push(a.lng()),h.push(a.lat())}var d=b.getNorthEast(),e=b.getSouthWest(),f=new google.maps.LatLng(d.lat(),e.lng()),g=new google.maps.LatLng(e.lat(),d.lng()),h=[];return c(f),c(e),c(g),c(d),c(f),a.debug("boundsToCoords",b,h),h},g}]).directive("propertyFeatureInfoWindow",[function(){return{restrict:"E",template:'<h3>{{f.name()}}</h3><ul class="list-unstyled"><li ng-repeat="(key,value) in f.properties()"><label>{{key}}</label> {{value}}</li></ul>',scope:{f:"=feature"}}}]),angular.module("templates-app-container-geo",["js/admin/layer-create-eprops-popover.html","js/admin/layer-create-idfmt-popover.html","js/admin/layer-create-input-form.html","js/admin/layer-create-lname-popover.html","js/admin/layer-create-lsource-popover.html","js/admin/layer-create-nmfmt-popover.html","js/admin/layer-create.html","js/admin/map-layer-administration.html"]),angular.module("js/admin/layer-create-eprops-popover.html",[]).run(["$templateCache",function(a){a.put("js/admin/layer-create-eprops-popover.html",'<div>\n    <p>The properties below represent the superset of all available properties\n        across all features within your new layer.  Displayed values are pulled\n        from first feature to have the given property set.</p>\n\n    <p>Properties flagged with the <i class="fa fa-key" aria-hidden="true"></i>\n        icon have values that are unique across all features within your new layer.</p>\n\n    <p>If a property has an explicit type (e.g. <code>string</code>,<code>number</code>\n        or <code>boolean</code>) then this indicates the property is available\n        on all features and has a consistent type across them.</p>\n\n    <p>A property type of <code>mixed</code> almost certainly indicates that\n        property in question is either unset or is <code>null</code>\n        for some features.</p>\n</div>\n')}]),angular.module("js/admin/layer-create-idfmt-popover.html",[]).run(["$templateCache",function(a){a.put("js/admin/layer-create-idfmt-popover.html","<div>\n    <p>Each feature added to the system must have an id that identifies it uniquely\n        within its layer.</p>\n    <p>If this layer is updated in the future (e.g. boundaries re-defined) it may be\n        desireable to allow the feature data to be updated in place rather than\n        recreated.  For example if other entities are to be associated with a given feature\n        to prevent data integrity problems.</p>\n    <p>The property format syntax is basic <code>sprintf</code> format without\n        surrounding <code>&quot;</code> characters.  Unlike standard <code>sprintf</code>\n        you can wrap optional properties in <code>[]</code>.</p>\n    <p><em>Example:</em> If your features had a unique property, <code>GEOID</code> that\n        is guaranteed to remain constant moving forward you could specify a format\n        like <code>%s,GEOID</code>.</p>\n    <p><em>Example:</em> If your features had two properties then when put together\n        would guarantee uniqueness, and remain constant moving forward, you could\n        specify a format like <code>%s.%s,MAINID,SUBID</code>.</p>\n</div>\n")}]),angular.module("js/admin/layer-create-input-form.html",[]).run(["$templateCache",function(a){a.put("js/admin/layer-create-input-form.html",'<form name="newLayerForm" ng-if="userInput && preResults">\n    <div layout="column">\n        <div style="margin-bottom: 10px;">\n            <label for="inputFile">Source File</label>\n            <div id="inputFile" class="file-info" file="uploadedFile"></div>\n        </div>\n        <md-input-container>\n            <label>Layer Name <!--i uib-popover-template="\'js/admin/layer-create-lname-popover.html\'" popover-placement="auto right" class="fa fa-info-circle" aria-hidden="true"></i--></label>\n            <input name="layerName" type="text" ng-model="userInput.layerName" layer-name-validate required />\n            <div ng-messages="newLayerForm.layerName.$error">\n                <div ng-message="layerNameinUse">This layer name is already in use.</div>\n            </div>\n        </md-input-container>\n        <md-input-container>\n            <label>Feature Id Format <!--i uib-popover-template="\'js/admin/layer-create-idfmt-popover.html\'" popover-placement="auto right" class="fa fa-info-circle" aria-hidden="true"></i--></label>\n            <input name="featureIdFmt" type="text" ng-model="userInput.featureIdFmt"\n                   property-format-validate="preResults.exampleProperties" required />\n           <div ng-messages="newLayerForm.featureIdFmt.$error">\n               <div ng-message="propertyFormat">Invalid format.</div>\n           </div>\n        </md-input-container>\n        <md-input-container>\n            <label for="featureNameFmt">Feature Name Format <!--i uib-popover-template="\'js/admin/layer-create-nmfmt-popover.html\'" popover-placement="auto right" class="fa fa-info-circle" aria-hidden="true"></i--></label>\n            <input name="featureNameFmt" type="text" ng-model="userInput.featureNameFmt"\n                   property-format-validate="preResults.exampleProperties" required />\n           <div ng-messages="newLayerForm.featureNameFmt.$error">\n               <div ng-message="propertyFormat">Invalid format.</div>\n           </div>\n        </md-input-container>\n        <md-input-container>\n            <label>Layer Source <!--i uib-popover-template="\'js/admin/layer-create-lsource-popover.html\'" popover-placement="auto right" class="fa fa-info-circle" aria-hidden="true"></i--></label>\n            <input name="layerSource" type="url" ng-model="userInput.layerSource" />\n            <div ng-messages="newLayerForm.layerSource.$error">\n                <div ng-message="url">Invalid url.</div>\n            </div>\n        </md-input-container>\n        <div layout="row" layout-align="end end">\n            <md-button ng-click="dismiss()">Cancel</md-button>\n            <md-button class="md-primary" ng-click="add()" ng-disabled="newLayerForm.$invalid">OK</md-button>\n        </div>\n    </div>\n</form>\n<div class="example-layer-properties"></div>\n')}]),angular.module("js/admin/layer-create-lname-popover.html",[]).run(["$templateCache",function(a){a.put("js/admin/layer-create-lname-popover.html","<div>\n    Specify your layer name here.  Your layer name must be unique within the system.\n</div>\n")}]),angular.module("js/admin/layer-create-lsource-popover.html",[]).run(["$templateCache",function(a){a.put("js/admin/layer-create-lsource-popover.html","<div>\n    <p>It may be useful to keep track of where the source of this layer originated.\n    If you downloaded the data from a web address you can record that here.</p>\n</div>\n")}]),angular.module("js/admin/layer-create-nmfmt-popover.html",[]).run(["$templateCache",function(a){a.put("js/admin/layer-create-nmfmt-popover.html","<div>\n    <p>Each feature added to the system should have a friendly name to identify it.\n        Feature names are generated from each feature's properties.</p>\n    <p>The property format syntax is basic <code>sprintf</code> format without\n        surrounding <code>&quot;</code> characters.  Unlike standard <code>sprintf</code>\n        you can wrap optional properties in <code>[]</code>.</p>\n    <p><em>Example:</em> If your features had a unique property, <code>UNITNAME</code> that\n        is guaranteed to remain constant moving forward you could specify a format\n        like <code>%s,UNITNAME</code>.</p>\n    <p><em>Example:</em> If your features had two properties then when put together\n        would create a more meaningful feature name, but one of the two properties\n        is not always available (not unique, type <code>mixed</code>), you might\n        specify a format like <code>%s[ (%s)],UNITNAME,SUBUNITNAME</code>.</p>\n</div>\n")}]),angular.module("js/admin/layer-create.html",[]).run(["$templateCache",function(a){a.put("js/admin/layer-create.html",'<section class="app-panel add-layer-dialog">\n    <md-toolbar class="md-toolbar-tools">\n        <h2 flex md-truncate>Add new layer</h2>\n        <md-progress-circular md-mode="indeterminate" ng-if="!STATE || [STATE.FILE_UPLOAD,STATE.USER_INPUT].indexOf(STATE) !== -1"></md-progress-circular>\n        <md-button class="md-icon-button close-dialog" aria-label="Close dialog" ng-click="dismiss()"></md-button>\n    </md-toolbar>\n    <md-content layout-padding>\n        <p ng-if="!STATE">Waiting to establish connection...</p>\n\n        <div ng-show="STATE === STATES.FILE_UPLOAD">\n            <p>Start by uploading the source of your layer (currently only zipped shapfile or ndjson).</p>\n            <input type="file" file-model="fileToUpload" file-resource="fileResource" />\n        </div>\n\n        <div ng-show="STATE === STATES.USER_INPUT">\n            <p>Your new layer will have <mark>{{preResults.featureCount}}</mark> features (assuming they can all\n                be successfully indexed).</p>\n            <div class="layer-create-input-form clearfix"></div>\n        </div>\n\n        <div ng-show="STATE === STATES.POST_PROCESS_RUNNING || (STATE === STATES.COMPLETE && userInput)">\n            <ul class="list-unstyled layer-create-messages">\n                <li ng-if="STATE === STATES.COMPLETE && userInput">Layer {{userInput.layerName}} added.</li>\n                <li ng-repeat="msg in infoMessages"><code class="{{msg.cls}}">{{msg.text}}</code></li>\n            </ul>\n        </div>\n    </md-content>\n</section>\n')}]),angular.module("js/admin/map-layer-administration.html",[]).run(["$templateCache",function(a){a.put("js/admin/map-layer-administration.html",'<md-switch id="admin-mode-toggle" aria-label="Toggle administration mode" ng-model="enabled"></md-switch>\n<span ng-if="enabled">\n    <md-autocomplete id="admin-layer-find" ng-if="!selection.layer" flex\n        md-no-cache="true"\n        md-selected-item="selection.layer"\n        md-search-text="layerSearch"\n        md-items="layer in findLayer(layerSearch)"\n        md-item-text="layer.name"\n        md-min-length="0"\n        placeholder="Put an existing layer on the map">\n        <md-item-template>\n            <span md-highlight-text="layerSearch">{{layer.name}}</span>\n        </md-item-template>\n    </md-autocomplete>\n\n    <md-button id="admin-layer-create" class="md-icon-button md-primary"\n        ng-if="!selection.layer"\n        ng-click="createLayer()"\n        aria-label="Add new layer">\n        <md-tooltip md-direction="left">Add new layer</md-tooltip>\n        <i class="fa fa-plus" aria-hidden="true"></i>\n    </md-button>\n\n    <md-card id="admin-layer-info" ng-if="selection.layer">\n        <md-card-title>\n            <md-card-title-text>\n                <span class="md-headline">{{selection.layer.name}}</span>\n                <span class="md-subhead feature-counts" ng-if="displayedOfTotal">displaying {{displayedOfTotal}} features</span>\n                <span class="md-subhead file-info" file="selection.layer._sourceFile"></span>\n            </md-card-title-text>\n        </md-card-title>\n        <md-card-actions layout="row" layout-align="end center">\n            <md-button class="md-icon-button" ng-click="removeLayer(selection.layer)" aria-label="Delete layer">\n                <md-tooltip>Delete layer</md-tooltip>\n                <i class="fa fa-2x fa-trash" aria-hidden="true"></i>\n            </md-button>\n            <md-button class="md-icon-button" ng-click="selection.layer=null">\n                <md-tooltip>Remove layer from map</md-tooltip>\n                <i class="fa fa-2x fa-times" aria-hidden="true"></i>\n            </md-button>\n        </md-card-actions>\n    </md-card>\n</span>\n')}]);